<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.Zackeus.WeChat_YuLon.modules.wechat.dao.OrderDao">

    <sql id="orderColumns">
    	MTD.[EXTERNAL_CONTRACT_NBR] AS "externalContractNbr",
    	MND.[ASSET_BRAND_DSC] AS "assetBrandDsc",
    	MND.[ASSET_MODEL_DSC] AS "assetModelDsc",
    	MTD.[AMOUNT_FINANCED] AS "amountFinanced",
    	MTD.[ACTUAL_RTE] AS "actualRte",
    	MTD.[INSTALLMENT_AMT] AS "installmentAmt"
    </sql>
    
	<!-- 获取当前用户符合合同号的合同详情 -->
	<select id="getByPrinciple" resultType="OrderDetail">
		SELECT
		<include refid="orderColumns"/>
		FROM [WeChat].[dbo].[WECHAT_USER] WU
		LEFT JOIN [10.5.60.90].[FinanceCopy].[dbo].[MIS_CUSTOMER_DETAIL] MRD ON WU.[NAME] = MRD.[EXP_APPLICANT_NAME]
			AND WU.[ID_CARD] = MRD.[EXP_APPLICANT_CARD_ID] AND WU.[PHONE_NUM] = MRD.[PHONE_NUMBER]
		LEFT JOIN [10.5.60.90].[FinanceCopy].[dbo].[MIS_CONTRACT_DETAIL] MTD ON MRD.[APPLICATION_NUMBER] = MTD.[PROPOSAL_NBR]
		LEFT JOIN [10.5.60.90].[FinanceCopy].[dbo].[MIS_APPLICATION_DETAIL] MND ON MTD.[PROPOSAL_NBR] = MND.[APPLICATION_NUMBER]
		WHERE WU.[OPEN_ID] = #{openId} AND MTD.[EXTERNAL_CONTRACT_NBR] = #{externalContractNbr}
	</select>
	
	<!-- 查询还款计划 -->
	<select id="getOrderRepayPlan">
		SELECT 
			EXTERNAL_CONTRACT_NBR,RENTAL_ID,DUE_DTE ,PRINCIPAL_SETTLED_AMT ,
			PRINCIPAL_AMT ,INTEREST_SETTLED_AMT ,INTEREST_AMT ,OVERDUE_SETTLED_AMT ,
			OVERDUE_AMT ,OVERDUE_DD ,RENTAL_AMT,SETTLE_AMT,OD_DAYS ,REPAYMENT_SETTLED_AMT ,REPAYMENT_AMT ,
			CASE WHEN RENTAL_AMT = SETTLE_AMT THEN '已还款' WHEN RENTAL_AMT > SETTLE_AMT THEN '部分还款' WHEN SETTLE_AMT IS NULL AND OD_DAYS > 0 THEN '逾期' WHEN SETTLE_AMT IS NULL AND OD_DAYS IS NULL THEN '还款日未到' END REPAYMENT_TYPE,
			CASE WHEN RENTAL_AMT = SETTLE_AMT THEN 'finish' WHEN RENTAL_AMT > SETTLE_AMT THEN 'process' WHEN SETTLE_AMT IS NULL AND OD_DAYS > 0 THEN 'error' WHEN SETTLE_AMT IS NULL AND OD_DAYS IS NULL THEN 'wait' END REPAYMENT_STATUS,
			CONVERT(NVARCHAR(10),MAX(EXECUTION_DTE),120) SETTLED_DATE 
		FROM OPENQUERY(YFC_PROD,' 
			SELECT C.EXTERNAL_CONTRACT_NBR, RP.RENTAL_ID ,TO_CHAR(RP.DUE_DTE,''yyyy-MM-dd'') DUE_DTE ,
				RP.PRINCIPAL_SETTLED_AMT ,RAS.PRINCIPAL_AMT ,RP.INTEREST_SETTLED_AMT ,
				RAS.INTEREST_AMT ,(ISNULL(RO.CHARGE_WAIVE_AMT,0)+ISNULL(RO.SETTLE_AMT,0)) OVERDUE_SETTLED_AMT ,
				ISNULL(RO.OVERDUE_AMT,0) OVERDUE_AMT ,
				ISNULL(RO.OVERDUE_DD,0) OVERDUE_DD ,
				RP.RENTAL_AMT,RP.SETTLE_AMT,RP.OD_DAYS ,
				(RP.PRINCIPAL_SETTLED_AMT+RP.INTEREST_SETTLED_AMT + (ISNULL(RO.CHARGE_WAIVE_AMT,0)+ISNULL(RO.SETTLE_AMT,0)) ) REPAYMENT_SETTLED_AMT ,
				(RAS.PRINCIPAL_AMT+RAS.INTEREST_AMT+ISNULL(RO.OVERDUE_AMT,0) ) REPAYMENT_AMT ,
				RT.EXECUTION_DTE 
			FROM CONTRACT C 
			LEFT JOIN REPAYMENT_PLAN RP ON C.CONTRACT_ID = RP.CONTRACT_ID 
			LEFT JOIN RENTAL_AMORTIZATION_SCHEDULE RAS ON RP.CONTRACT_ID = RAS.CONTRACT_ID AND RP.AGREEMENT_SEQ = RAS.AGREEMENT_SEQ AND RP.RENTAL_ID = RAS.RENTAL_ID 
			LEFT JOIN RENTAL_OVERDUE RO ON RP.CONTRACT_ID = RO.CONTRACT_ID AND RP.AGREEMENT_SEQ = RO.AGREEMENT_SEQ AND RP.RENTAL_ID = RO.RENTAL_ID 
			LEFT JOIN RENTAL_TRANS RT ON C.CONTRACT_ID = RT.CONTRACT_ID AND RP.RENTAL_ID = RT.RENTAL_ID AND RP.AGREEMENT_SEQ = RT.AGREEMENT_SEQ 
			WHERE C.EXTERNAL_CONTRACT_NBR = ''{externalContractNbr}'' ORDER BY RP.RENTAL_ID ') 
			GROUP BY EXTERNAL_CONTRACT_NBR,RENTAL_ID,DUE_DTE ,PRINCIPAL_SETTLED_AMT ,PRINCIPAL_AMT ,INTEREST_SETTLED_AMT ,INTEREST_AMT ,OVERDUE_SETTLED_AMT ,OVERDUE_AMT ,OVERDUE_DD ,RENTAL_AMT,SETTLE_AMT,OD_DAYS ,REPAYMENT_SETTLED_AMT ,REPAYMENT_AMT 
	</select>
	
	<select id="getOrderRepayPlanParameter" resultType="OrderRepayPlan" parameterType="java.lang.String">
		${_parameter} 
	</select>
	
	<!-- 查询逾期还款 -->
	<select id="getOverdueOrderRepay">
		SELECT 
			EXTERNAL_CONTRACT_NBR,RENTAL_ID,DUE_DTE ,PRINCIPAL_SETTLED_AMT ,
			PRINCIPAL_AMT ,INTEREST_SETTLED_AMT ,INTEREST_AMT ,OVERDUE_SETTLED_AMT ,
			OVERDUE_AMT ,OVERDUE_DD ,RENTAL_AMT,SETTLE_AMT,OD_DAYS ,REPAYMENT_SETTLED_AMT ,REPAYMENT_AMT ,
			CASE WHEN RENTAL_AMT = SETTLE_AMT THEN '已还款' WHEN RENTAL_AMT > SETTLE_AMT THEN '部分还款' WHEN SETTLE_AMT IS NULL AND OD_DAYS > 0 THEN '逾期' WHEN SETTLE_AMT IS NULL AND OD_DAYS IS NULL THEN '还款日未到' END REPAYMENT_TYPE,
			CASE WHEN RENTAL_AMT = SETTLE_AMT THEN 'finish' WHEN RENTAL_AMT > SETTLE_AMT THEN 'process' WHEN SETTLE_AMT IS NULL AND OD_DAYS > 0 THEN 'error' WHEN SETTLE_AMT IS NULL AND OD_DAYS IS NULL THEN 'wait' END REPAYMENT_STATUS,
			CONVERT(NVARCHAR(10),MAX(EXECUTION_DTE),120) SETTLED_DATE 
		FROM OPENQUERY(YFC_PROD,' 
			SELECT C.EXTERNAL_CONTRACT_NBR, RP.RENTAL_ID ,TO_CHAR(RP.DUE_DTE,''yyyy-MM-dd'') DUE_DTE ,
				RP.PRINCIPAL_SETTLED_AMT ,RAS.PRINCIPAL_AMT ,RP.INTEREST_SETTLED_AMT ,
				RAS.INTEREST_AMT ,(ISNULL(RO.CHARGE_WAIVE_AMT,0)+ISNULL(RO.SETTLE_AMT,0)) OVERDUE_SETTLED_AMT ,
				ISNULL(RO.OVERDUE_AMT,0) OVERDUE_AMT ,
				ISNULL(RO.OVERDUE_DD,0) OVERDUE_DD ,
				RP.RENTAL_AMT,RP.SETTLE_AMT,RP.OD_DAYS ,
				(RP.PRINCIPAL_SETTLED_AMT+RP.INTEREST_SETTLED_AMT + (ISNULL(RO.CHARGE_WAIVE_AMT,0)+ISNULL(RO.SETTLE_AMT,0)) ) REPAYMENT_SETTLED_AMT ,
				(RAS.PRINCIPAL_AMT+RAS.INTEREST_AMT+ISNULL(RO.OVERDUE_AMT,0) ) REPAYMENT_AMT ,
				RT.EXECUTION_DTE 
			FROM CONTRACT C 
			LEFT JOIN REPAYMENT_PLAN RP ON C.CONTRACT_ID = RP.CONTRACT_ID 
			LEFT JOIN RENTAL_AMORTIZATION_SCHEDULE RAS ON RP.CONTRACT_ID = RAS.CONTRACT_ID AND RP.AGREEMENT_SEQ = RAS.AGREEMENT_SEQ AND RP.RENTAL_ID = RAS.RENTAL_ID 
			LEFT JOIN RENTAL_OVERDUE RO ON RP.CONTRACT_ID = RO.CONTRACT_ID AND RP.AGREEMENT_SEQ = RO.AGREEMENT_SEQ AND RP.RENTAL_ID = RO.RENTAL_ID 
			LEFT JOIN RENTAL_TRANS RT ON C.CONTRACT_ID = RT.CONTRACT_ID AND RP.RENTAL_ID = RT.RENTAL_ID AND RP.AGREEMENT_SEQ = RT.AGREEMENT_SEQ 
			WHERE C.EXTERNAL_CONTRACT_NBR = ''{externalContractNbr}'' ORDER BY RP.RENTAL_ID ')
			WHERE RENTAL_AMT > SETTLE_AMT OR (SETTLE_AMT IS NULL AND OD_DAYS > 0)
			GROUP BY EXTERNAL_CONTRACT_NBR,RENTAL_ID,DUE_DTE ,PRINCIPAL_SETTLED_AMT ,PRINCIPAL_AMT ,INTEREST_SETTLED_AMT ,INTEREST_AMT ,OVERDUE_SETTLED_AMT ,OVERDUE_AMT ,OVERDUE_DD ,RENTAL_AMT,SETTLE_AMT,OD_DAYS ,REPAYMENT_SETTLED_AMT ,REPAYMENT_AMT 
	</select>
	
	<select id="getOverdueOrderRepayParameter" resultType="OrderRepayPlan" parameterType="java.lang.String">
		${_parameter} 
	</select>
	
</mapper>  
